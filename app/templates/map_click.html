<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Sea Temperature â€¢ Map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        * { box-sizing: border-box; }

        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
            background: #0b1c2d;
        }

        #map { height: 100vh; width: 100vw; }

        /* â”€â”€ Shared panel chrome â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .panel {
            position: absolute;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.97);
            border-radius: 20px;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.14);
            color: #1e293b;
        }

        .panel-title { font-size: 15px; font-weight: 800; }
        .muted { font-size: 13px; color: #64748b; line-height: 1.5; }

        /* â”€â”€ Info panel (left) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        #info-panel { top: 24px; left: 24px; width: 300px; padding: 22px; }

        .temp-big {
            font-size: 52px;
            font-weight: 900;
            letter-spacing: -2px;
            line-height: 1;
            margin: 16px 0 6px;
        }

        .badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 700;
            color: white;
        }

        .meta { font-size: 12px; color: #94a3b8; margin-top: 8px; }

        .panel-links { margin-top: 18px; display: flex; gap: 8px; }
        .panel-links a {
            padding: 9px 16px;
            border-radius: 14px;
            font-size: 13px;
            font-weight: 700;
            text-decoration: none;
        }
        .btn-primary { background: #0ea5e9; color: white; }
        .btn-primary:hover { background: #0284c7; }
        .btn-secondary { background: #f1f5f9; color: #475569; }
        .btn-secondary:hover { background: #e2e8f0; }

        .spinner {
            width: 22px; height: 22px;
            margin-top: 16px;
            border: 3px solid #e2e8f0;
            border-top-color: #0ea5e9;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* â”€â”€ Legend panel (right) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        #legend-panel { top: 24px; right: 24px; width: 215px; padding: 18px 16px; }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 7px 8px;
            border-radius: 10px;
            cursor: default;
            transition: background 0.15s;
            user-select: none;
        }
        .legend-item:hover { background: #f1f5f9; }

        .legend-dot {
            width: 13px; height: 13px;
            border-radius: 50%;
            flex-shrink: 0;
            transition: transform 0.15s;
        }
        .legend-item:hover .legend-dot { transform: scale(1.4); }

        .legend-label { font-size: 13px; font-weight: 700; flex: 1; }
        .legend-range { font-size: 11px; color: #94a3b8; }

        #legend-status {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #f1f5f9;
            font-size: 11px;
            color: #94a3b8;
            min-height: 16px;
        }
    </style>
</head>

<body>

<div id="map"></div>

<!-- Left: click-to-inspect result -->
<div class="panel" id="info-panel">
    <div class="panel-title">ðŸŒŠ Sea Temperature</div>
    <div id="info" class="muted" style="margin-top: 10px;">
        Click anywhere on the ocean to check the water temperature.
    </div>
    <div class="panel-links">
        <a href="/" class="btn-primary">Home</a>
        <a href="/about" class="btn-secondary">About</a>
    </div>
</div>

<!-- Right: interactive legend -->
<div class="panel" id="legend-panel">
    <div class="panel-title" style="margin-bottom: 12px;">Temperature Guide</div>
    <div id="legend-items"></div>
    <div id="legend-status">Loading dataâ€¦</div>
</div>

<script>
    // â”€â”€ Temperature band definitions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const BANDS = [
        { label: "Cold",      range: "< 17Â°C",   color: "#2563eb" },
        { label: "Brave",     range: "17â€“20Â°C",  color: "#0ea5e9" },
        { label: "Nice",      range: "20â€“23Â°C",  color: "#22c55e" },
        { label: "Perfect",   range: "23â€“26Â°C",  color: "#f59e0b" },
        { label: "Very Warm", range: "> 26Â°C",   color: "#ef4444" },
    ];

    function bandIndex(t) {
        if (t < 17) return 0;
        if (t < 20) return 1;
        if (t < 23) return 2;
        if (t < 26) return 3;
        return 4;
    }

    // â”€â”€ Map initialisation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const map = L.map("map").setView([36, 18], 5);
    L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 12,
        attribution: "Â© OpenStreetMap contributors",
    }).addTo(map);

    // â”€â”€ Temperature boundary canvas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    //
    // Instead of filled circles (which merge into opaque blobs at low zoom),
    // we detect edges between adjacent 0.05Â° cells and draw a thin coloured
    // line wherever the temperature band changes â€” leaving the ocean interior
    // fully transparent and the map clean.
    //
    const canvas = document.createElement("canvas");
    canvas.style.cssText = "position:absolute;top:0;left:0;pointer-events:none;z-index:450;";
    map.getContainer().appendChild(canvas);

    let boundaries = [];   // pre-computed boundary line segments
    let activeBand = null; // index of hovered legend item, or null = show all
    let clickPos   = null; // last clicked { lat, lon } â€” drawn as a dot on canvas

    const STEP = 0.05;   // dataset grid resolution in degrees
    const HALF = STEP / 2;

    // â”€â”€ Boundary computation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    //
    // For each grid cell, check its four neighbours. We only draw a segment
    // where the neighbour is missing (land or outside the loaded area), i.e.
    // the ocean-to-shore edge. Interior ocean cells produce no lines at all,
    // so the map stays clean and only the coastline is coloured.
    //
    // Keys use Math.round(coord * 20) so floating-point noise in the API values
    // never causes a missed lookup, and so shared-wall deduplication is exact
    // (the key identifies the *western* cell for vertical walls, the *southern*
    // cell for horizontal walls).
    //
    function computeBoundaries(points) {
        const lookup = new Map();
        for (const { lat, lon, temp_c } of points) {
            lookup.set(`${Math.round(lat * 20)}_${Math.round(lon * 20)}`, bandIndex(temp_c));
        }

        const getBand = (lat, lon) => {
            const v = lookup.get(`${Math.round(lat * 20)}_${Math.round(lon * 20)}`);
            return v !== undefined ? v : -1;  // -1 = land or out-of-view
        };

        const segs = [];
        const seen = new Set();

        const addEdge = (key, lat1, lon1, lat2, lon2, b1, b2) => {
            if (seen.has(key)) return;
            seen.add(key);
            segs.push({ lat1, lon1, lat2, lon2, b1, b2 });
        };

        for (const { lat, lon, temp_c } of points) {
            const b    = bandIndex(temp_c);
            const rLat = Math.round(lat * 20);
            const rLon = Math.round(lon * 20);

            // East wall â€” only when east neighbour is land/missing
            const bE = getBand(lat, lon + STEP);
            if (bE === -1) addEdge(
                `V_${rLat}_${rLon}`,
                lat - HALF, lon + HALF, lat + HALF, lon + HALF, b, bE,
            );

            // West wall â€” only when west neighbour is land/missing
            const bW = getBand(lat, lon - STEP);
            if (bW === -1) addEdge(
                `V_${rLat}_${Math.round((lon - STEP) * 20)}`,
                lat - HALF, lon - HALF, lat + HALF, lon - HALF, b, bW,
            );

            // North wall â€” only when north neighbour is land/missing
            const bN = getBand(lat + STEP, lon);
            if (bN === -1) addEdge(
                `H_${rLat}_${rLon}`,
                lat + HALF, lon - HALF, lat + HALF, lon + HALF, b, bN,
            );

            // South wall â€” only when south neighbour is land/missing
            const bS = getBand(lat - STEP, lon);
            if (bS === -1) addEdge(
                `H_${Math.round((lat - STEP) * 20)}_${rLon}`,
                lat - HALF, lon - HALF, lat - HALF, lon + HALF, b, bS,
            );
        }

        return segs;
    }

    // â”€â”€ Canvas draw â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    //
    // Project every boundary segment to container pixels and stroke it.
    // When `active` is set, all segments not touching that band are dimmed.
    // The click marker is drawn last so it always appears on top.
    //
    function drawBoundaries(active = null) {
        const size    = map.getSize();
        canvas.width  = size.x;
        canvas.height = size.y;

        const ctx = canvas.getContext("2d");
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.lineWidth = 3;
        ctx.lineCap   = "round";

        for (const { lat1, lon1, lat2, lon2, b1, b2 } of boundaries) {
            const isActive = active === null || b1 === active || b2 === active;
            ctx.globalAlpha = isActive ? 0.9 : 0.06;
            ctx.strokeStyle = BANDS[b1].color;  // b2 is always -1 (land), colour by ocean band

            const p1 = map.latLngToContainerPoint([lat1, lon1]);
            const p2 = map.latLngToContainerPoint([lat2, lon2]);
            ctx.beginPath();
            ctx.moveTo(p1.x, p1.y);
            ctx.lineTo(p2.x, p2.y);
            ctx.stroke();
        }

        // Click marker â€” always on top of the boundary lines
        if (clickPos) {
            const p = map.latLngToContainerPoint([clickPos.lat, clickPos.lon]);
            ctx.globalAlpha = 1;
            ctx.beginPath();
            ctx.arc(p.x, p.y, 10, 0, Math.PI * 2);
            ctx.fillStyle   = "#0ea5e9";
            ctx.fill();
            ctx.strokeStyle = "#ffffff";
            ctx.lineWidth   = 3;
            ctx.stroke();
        }

        ctx.globalAlpha = 1;
    }

    // â”€â”€ Legend â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    BANDS.forEach((b, i) => {
        const item = document.createElement("div");
        item.className = "legend-item";
        item.innerHTML = `
            <div class="legend-dot" style="background:${b.color}"></div>
            <span class="legend-label">${b.label}</span>
            <span class="legend-range">${b.range}</span>
        `;
        item.addEventListener("mouseenter", () => { activeBand = i; drawBoundaries(i); });
        item.addEventListener("mouseleave", () => { activeBand = null; drawBoundaries(null); });
        document.getElementById("legend-items").appendChild(item);
    });

    // â”€â”€ Overlay loader â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let overlayTimer = null;

    async function loadOverlay() {
        const bounds = map.getBounds();
        const minLon = Math.max(-180, bounds.getWest());
        const maxLon = Math.min( 180, bounds.getEast());
        const url = `/api/area`
            + `?min_lat=${bounds.getSouth().toFixed(3)}`
            + `&max_lat=${bounds.getNorth().toFixed(3)}`
            + `&min_lon=${minLon.toFixed(3)}`
            + `&max_lon=${maxLon.toFixed(3)}`;

        try {
            const res = await fetch(url);
            if (!res.ok) return;
            const { points } = await res.json();

            boundaries = computeBoundaries(points);
            drawBoundaries(activeBand);

            const status = document.getElementById("legend-status");
            status.textContent = points.length === 0
                ? "No cached data here â€” click to load"
                : `${points.length.toLocaleString()} points Â· hover to highlight`;
        } catch (_) {
            // Overlay is best-effort; never block the user
        }
    }

    // Hide canvas during pan for a clean UX; redraw with correct projection on settle
    map.on("movestart", () => { canvas.style.display = "none"; });
    map.on("moveend",   () => {
        canvas.style.display = "";
        drawBoundaries(activeBand);
        clearTimeout(overlayTimer);
        overlayTimer = setTimeout(loadOverlay, 500);
    });

    window.addEventListener("resize", () => drawBoundaries(activeBand));

    loadOverlay();  // Paint on first render

    // â”€â”€ Click-to-inspect â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function onMapClick(e) {
        const { lat, lng: lon } = map.wrapLatLng(e.latlng);

        // Show the click position immediately while we fetch
        clickPos = { lat, lon };
        drawBoundaries(activeBand);

        document.getElementById("info").innerHTML = `<div class="spinner"></div>`;

        let data;
        try {
            const res = await fetch(`/api/point?lat=${lat}&lon=${lon}&radius_km=10`);
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            data = await res.json();
        } catch (_) {
            document.getElementById("info").innerHTML =
                `<span class="muted">Could not fetch data â€” please try again.</span>`;
            return;
        }

        if (data.status !== "ok") {
            document.getElementById("info").innerHTML =
                `<span class="muted">No ocean data at this location.</span>`;
            return;
        }

        const band = BANDS[bandIndex(data.mean_c)];
        document.getElementById("info").innerHTML = `
            <div class="muted">Updated ${data.date}</div>
            <div class="temp-big">
                ${data.mean_c.toFixed(1)}<span style="font-size:22px;font-weight:500"> Â°C</span>
            </div>
            <div class="badge" style="background:${band.color}">${band.label}</div>
            <div class="meta">${data.radius_km} km radius Â· ${data.cells_used} cells</div>
        `;

        // Refresh overlay â€” this click may have fetched and cached a new tile
        loadOverlay();
    }

    map.on("click", onMapClick);
</script>

</body>
</html>
