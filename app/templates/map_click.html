<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Sea Temperature â€¢ Map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        * { box-sizing: border-box; }

        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
            background: #e8eaed;
        }

        #map { height: 100vh; width: 100vw; }

        /* â”€â”€ Shared panel chrome â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .panel {
            position: absolute;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.72);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.07), 0 16px 40px rgba(0, 0, 0, 0.11);
            color: #1e293b;
        }

        .panel-title { font-size: 15px; font-weight: 800; }
        .muted { font-size: 13px; color: #64748b; line-height: 1.5; }

        /* â”€â”€ Info panel (left) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        #info-panel { top: 24px; left: 24px; width: 300px; overflow: hidden; }

        #info-color-bar {
            height: 4px;
            border-radius: 20px 20px 0 0;
            display: none;
            transition: background 0.4s ease;
        }

        #info-content { padding: 20px 22px; }

        .temp-big {
            font-size: 54px;
            font-weight: 900;
            letter-spacing: -3px;
            line-height: 1;
            margin: 14px 0 8px;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 5px 14px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 700;
            color: white;
            letter-spacing: 0.3px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.18);
            margin-bottom: 6px;
        }

        .meta { font-size: 11px; color: #94a3b8; line-height: 1.7; }

        .panel-links { margin-top: 18px; display: flex; gap: 8px; }
        .panel-links a {
            padding: 9px 16px;
            border-radius: 14px;
            font-size: 13px;
            font-weight: 700;
            text-decoration: none;
        }
        .btn-primary { background: #0ea5e9; color: white; }
        .btn-primary:hover { background: #0284c7; }
        .btn-secondary { background: rgba(0, 0, 0, 0.06); color: #475569; }
        .btn-secondary:hover { background: rgba(0, 0, 0, 0.1); }

        .spinner {
            width: 22px; height: 22px;
            margin-top: 16px;
            border: 3px solid #e2e8f0;
            border-top-color: #0ea5e9;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* â”€â”€ Legend panel (right) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        #legend-panel { top: 24px; right: 24px; width: 200px; padding: 18px 16px; }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 6px 4px;
        }

        .legend-dot {
            width: 11px; height: 11px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .legend-label { font-size: 13px; font-weight: 700; flex: 1; }
        .legend-range { font-size: 11px; color: #94a3b8; }
    </style>
</head>

<body>

<div id="map"></div>

<!-- Left: click-to-inspect result -->
<div class="panel" id="info-panel">
    <div id="info-color-bar"></div>
    <div id="info-content">
        <div class="panel-title">Sea Temperature</div>
        <div id="info" class="muted" style="margin-top: 10px;">
            Click anywhere on the ocean to check the water temperature.
        </div>
        <div class="panel-links">
            <a href="/" class="btn-primary">Home</a>
            <a href="/about" class="btn-secondary">About</a>
        </div>
    </div>
</div>

<!-- Right: static colour reference -->
<div class="panel" id="legend-panel">
    <div class="panel-title" style="margin-bottom: 12px;">Temperature Guide</div>
    <div id="legend-items"></div>
</div>

<script>
    // â”€â”€ Temperature band definitions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const BANDS = [
        { label: "Cold",      range: "< 17Â°C",   color: "#2563eb" },
        { label: "Brave",     range: "17â€“20Â°C",  color: "#0ea5e9" },
        { label: "Nice",      range: "20â€“23Â°C",  color: "#22c55e" },
        { label: "Perfect",   range: "23â€“26Â°C",  color: "#f59e0b" },
        { label: "Very Warm", range: "> 26Â°C",   color: "#ef4444" },
    ];

    function bandIndex(t) {
        if (t < 17) return 0;
        if (t < 20) return 1;
        if (t < 23) return 2;
        if (t < 26) return 3;
        return 4;
    }

    // â”€â”€ Map â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const map = L.map("map").setView([36, 18], 5);
    L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png", {
        maxZoom: 19,
        subdomains: "abcd",
        attribution: 'Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors Â© <a href="https://carto.com/attributions">CARTO</a>',
    }).addTo(map);

    // â”€â”€ Static legend â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    BANDS.forEach((b) => {
        const item = document.createElement("div");
        item.className = "legend-item";
        item.innerHTML = `
            <div class="legend-dot" style="background:${b.color}"></div>
            <span class="legend-label">${b.label}</span>
            <span class="legend-range">${b.range}</span>
        `;
        document.getElementById("legend-items").appendChild(item);
    });

    // â”€â”€ Click-to-inspect â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let clickMarker = null;

    async function onMapClick(e) {
        const { lat, lng: lon } = map.wrapLatLng(e.latlng);

        // Place a marker at the clicked position immediately
        if (clickMarker) map.removeLayer(clickMarker);
        clickMarker = L.circleMarker([lat, lon], {
            radius:      8,
            weight:      3,
            color:       "#0ea5e9",
            fillColor:   "#ffffff",
            fillOpacity: 1,
        }).addTo(map);

        document.getElementById("info").innerHTML = `<div class="spinner"></div>`;

        let data;
        try {
            const res = await fetch(`/api/point?lat=${lat}&lon=${lon}&radius_km=10`);
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            data = await res.json();
        } catch (_) {
            document.getElementById("info").innerHTML =
                `<span class="muted">Could not fetch data â€” please try again.</span>`;
            return;
        }

        if (data.status !== "ok") {
            document.getElementById("info").innerHTML =
                `<span class="muted">No ocean data at this location.</span>`;
            return;
        }

        const band      = BANDS[bandIndex(data.mean_c)];
        const swimEmoji = data.mean_c >= 20 ? "ðŸŠ" : data.mean_c >= 17 ? "ðŸ¤¿" : "ðŸ¥¶";

        // Update marker colour to match the temperature band
        clickMarker.setStyle({ color: band.color });

        // Reveal colour bar at top of panel
        const bar = document.getElementById("info-color-bar");
        bar.style.display    = "block";
        bar.style.background = band.color;

        document.getElementById("info").innerHTML = `
            <div class="muted" style="font-size:11px;letter-spacing:0.5px;text-transform:uppercase;color:#94a3b8;">
                ${data.date}
            </div>
            <div class="temp-big">
                ${data.mean_c.toFixed(1)}<span style="font-size:22px;font-weight:400;color:#64748b"> Â°C</span>
            </div>
            <div class="badge" style="background:${band.color}">${swimEmoji} ${band.label}</div>
            <div class="meta">Averaged over ${data.radius_km} km Â· ${data.cells_used} cells</div>
        `;
    }

    map.on("click", onMapClick);
</script>

</body>
</html>
