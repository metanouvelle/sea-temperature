<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Sea Temperature â€¢ Map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        * { box-sizing: border-box; }

        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
            background: #0b1c2d;
        }

        #map { height: 100vh; width: 100vw; }

        /* â”€â”€ Shared panel chrome â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .panel {
            position: absolute;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.97);
            border-radius: 20px;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.14);
            color: #1e293b;
        }

        .panel-title { font-size: 15px; font-weight: 800; }
        .muted { font-size: 13px; color: #64748b; line-height: 1.5; }

        /* â”€â”€ Info panel (left) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        #info-panel { top: 24px; left: 24px; width: 300px; padding: 22px; }

        .temp-big {
            font-size: 52px;
            font-weight: 900;
            letter-spacing: -2px;
            line-height: 1;
            margin: 16px 0 6px;
        }

        .badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 700;
            color: white;
        }

        .meta { font-size: 12px; color: #94a3b8; margin-top: 8px; }

        .panel-links { margin-top: 18px; display: flex; gap: 8px; }
        .panel-links a {
            padding: 9px 16px;
            border-radius: 14px;
            font-size: 13px;
            font-weight: 700;
            text-decoration: none;
        }
        .btn-primary { background: #0ea5e9; color: white; }
        .btn-primary:hover { background: #0284c7; }
        .btn-secondary { background: #f1f5f9; color: #475569; }
        .btn-secondary:hover { background: #e2e8f0; }

        .spinner {
            width: 22px; height: 22px;
            margin-top: 16px;
            border: 3px solid #e2e8f0;
            border-top-color: #0ea5e9;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* â”€â”€ Legend panel (right) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        #legend-panel { top: 24px; right: 24px; width: 215px; padding: 18px 16px; }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 7px 8px;
            border-radius: 10px;
            cursor: default;
            transition: background 0.15s;
            user-select: none;
        }
        .legend-item:hover { background: #f1f5f9; }

        .legend-dot {
            width: 13px; height: 13px;
            border-radius: 50%;
            flex-shrink: 0;
            transition: transform 0.15s;
        }
        .legend-item:hover .legend-dot { transform: scale(1.4); }

        .legend-label { font-size: 13px; font-weight: 700; flex: 1; }
        .legend-range { font-size: 11px; color: #94a3b8; }

        #legend-status {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #f1f5f9;
            font-size: 11px;
            color: #94a3b8;
            min-height: 16px;
        }
    </style>
</head>

<body>

<div id="map"></div>

<!-- Left: click-to-inspect result -->
<div class="panel" id="info-panel">
    <div class="panel-title">ðŸŒŠ Sea Temperature</div>
    <div id="info" class="muted" style="margin-top: 10px;">
        Click anywhere on the ocean to check the water temperature.
    </div>
    <div class="panel-links">
        <a href="/" class="btn-primary">Home</a>
        <a href="/about" class="btn-secondary">About</a>
    </div>
</div>

<!-- Right: interactive legend -->
<div class="panel" id="legend-panel">
    <div class="panel-title" style="margin-bottom: 12px;">Temperature Guide</div>
    <div id="legend-items"></div>
    <div id="legend-status">Loading dataâ€¦</div>
</div>

<script>
    // â”€â”€ Temperature band definitions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const BANDS = [
        { label: "Cold",      range: "< 17Â°C",   color: "#2563eb" },
        { label: "Brave",     range: "17â€“20Â°C",  color: "#0ea5e9" },
        { label: "Nice",      range: "20â€“23Â°C",  color: "#22c55e" },
        { label: "Perfect",   range: "23â€“26Â°C",  color: "#f59e0b" },
        { label: "Very Warm", range: "> 26Â°C",   color: "#ef4444" },
    ];

    function bandIndex(t) {
        if (t < 17) return 0;
        if (t < 20) return 1;
        if (t < 23) return 2;
        if (t < 26) return 3;
        return 4;
    }

    // â”€â”€ Map initialisation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const map = L.map("map").setView([36, 18], 5);
    L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 12,
        attribution: "Â© OpenStreetMap contributors",
    }).addTo(map);

    // â”€â”€ Temperature overlay: one canvas pane per band â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    //
    // Each band gets its own Leaflet pane containing a single <canvas>.
    // Setting pane.style.opacity is a GPU-composited operation â€” it gives
    // smooth transitions without touching JS or re-drawing any canvas.
    //
    const bandLayers = BANDS.map((def, i) => {
        const paneName = `sst-band-${i}`;
        const pane     = map.createPane(paneName);
        pane.style.zIndex = String(400 + i);
        const renderer = L.canvas({ pane: paneName, padding: 0.5 });
        const layer    = L.layerGroup().addTo(map);
        return { ...def, pane, renderer, layer };
    });

    // â”€â”€ Legend â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const legendContainer = document.getElementById("legend-items");

    bandLayers.forEach((b, i) => {
        const item = document.createElement("div");
        item.className = "legend-item";
        item.innerHTML = `
            <div class="legend-dot" style="background:${b.color}"></div>
            <span class="legend-label">${b.label}</span>
            <span class="legend-range">${b.range}</span>
        `;
        // Hover: dim all other bands, keep this one full brightness
        item.addEventListener("mouseenter", () => {
            bandLayers.forEach((bl, j) => {
                bl.pane.style.transition = "opacity 0.2s ease";
                bl.pane.style.opacity    = j === i ? "1" : "0.06";
            });
        });
        item.addEventListener("mouseleave", () => {
            bandLayers.forEach(bl => {
                bl.pane.style.transition = "opacity 0.2s ease";
                bl.pane.style.opacity    = "1";
            });
        });
        legendContainer.appendChild(item);
    });

    // â”€â”€ Overlay loader â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let overlayTimer = null;

    async function loadOverlay() {
        const bounds = map.getBounds();
        // Clamp to [-180, 180] to handle overflow after heavy panning
        const minLon = Math.max(-180, bounds.getWest());
        const maxLon = Math.min( 180, bounds.getEast());
        const url = `/api/area`
            + `?min_lat=${bounds.getSouth().toFixed(3)}`
            + `&max_lat=${bounds.getNorth().toFixed(3)}`
            + `&min_lon=${minLon.toFixed(3)}`
            + `&max_lon=${maxLon.toFixed(3)}`;

        try {
            const res = await fetch(url);
            if (!res.ok) return;
            const { points } = await res.json();

            // Clear then re-draw all bands
            bandLayers.forEach(b => b.layer.clearLayers());
            points.forEach(({ lat, lon, temp_c }) => {
                const { renderer, layer, color } = bandLayers[bandIndex(temp_c)];
                L.circleMarker([lat, lon], {
                    renderer,
                    radius:      3,
                    weight:      0,
                    fillColor:   color,
                    fillOpacity: 0.72,
                }).addTo(layer);
            });

            const status = document.getElementById("legend-status");
            status.textContent = points.length === 0
                ? "No cached data here â€” click to load"
                : `${points.length.toLocaleString()} points Â· hover to highlight`;
        } catch (_) {
            // Overlay is best-effort; never block the user
        }
    }

    map.on("moveend", () => {
        clearTimeout(overlayTimer);
        overlayTimer = setTimeout(loadOverlay, 500);
    });

    loadOverlay();  // Paint on first render

    // â”€â”€ Click-to-inspect â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let clickMarker = null;

    async function onMapClick(e) {
        const { lat, lng: lon } = map.wrapLatLng(e.latlng);

        if (clickMarker) map.removeLayer(clickMarker);
        clickMarker = L.circleMarker([lat, lon], {
            radius:      10,
            weight:      2.5,
            color:       "#fff",
            fillColor:   "#0ea5e9",
            fillOpacity: 1,
        }).addTo(map);

        document.getElementById("info").innerHTML = `<div class="spinner"></div>`;

        let data;
        try {
            const res = await fetch(`/api/point?lat=${lat}&lon=${lon}&radius_km=10`);
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            data = await res.json();
        } catch (_) {
            document.getElementById("info").innerHTML =
                `<span class="muted">Could not fetch data â€” please try again.</span>`;
            return;
        }

        if (data.status !== "ok") {
            document.getElementById("info").innerHTML =
                `<span class="muted">No ocean data at this location.</span>`;
            return;
        }

        const { label, color } = (() => {
            const b = BANDS[bandIndex(data.mean_c)];
            return { label: b.label, color: b.color };
        })();

        document.getElementById("info").innerHTML = `
            <div class="muted">Updated ${data.date}</div>
            <div class="temp-big">
                ${data.mean_c.toFixed(1)}<span style="font-size:22px;font-weight:500"> Â°C</span>
            </div>
            <div class="badge" style="background:${color}">${label}</div>
            <div class="meta">${data.radius_km} km radius Â· ${data.cells_used} cells</div>
        `;

        // Refresh overlay if this click fetched a previously uncached tile
        loadOverlay();
    }

    map.on("click", onMapClick);
</script>

</body>
</html>
